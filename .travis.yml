language: csharp
solution: Springboard365.Xrm.Plugins.Core.sln
install:
  - nuget restore Springboard365.Xrm.Plugins.Core.sln
  - nuget install NUnit.ConsoleRunner -Version 3.4.1 -ExcludeVersion -OutputDirectory tools
  - nuget install Springboard365.Tools.DynamicsCrm.ImportCustomizations -PreRelease -ExcludeVersion -OutputDirectory tools
script:
  - xbuild Springboard365.Xrm.Plugins.Core.sln /p:Configuration=Release-Net40;TargetFrameworkProfile="";TargetFrameworkVersion=4.0
  - mono ./tools/NUnit.ConsoleRunner/tools/nunit3-console.exe ./Springboard365.Xrm.Plugins.Core.Test/bin/Release-Net40/Springboard365.Xrm.Plugins.Core.Test.dll  --work=./TestResult/Net40
  - xbuild Springboard365.Xrm.Plugins.Core.sln /p:Configuration=Release-Net45;TargetFrameworkProfile="";TargetFrameworkVersion=4.5
  - mono ./tools/NUnit.ConsoleRunner/tools/nunit3-console.exe ./Springboard365.Xrm.Plugins.Core.Test/bin/Release-Net45/Springboard365.Xrm.Plugins.Core.Test.dll  --work=./TestResult/Net45
  - echo -e "<?xml version=\"1.0\" encoding=\"utf-8\"?><configuration><connectionStrings><add name=\"CrmConnection\" connectionString=\"Url=$dynamics_crm_url; Username=$dynamics_crm_username; Password=$dynamics_crm_password; DeviceID=$dynamics_crm_device_id; DevicePassword=$dynamics_crm_device_password\"/></connectionStrings></configuration>" > ./Springboard365.Xrm.Plugins.Core.IntegrationTest/App.Config
  - nuget restore Springboard365.Xrm.Plugins.Core.IntegrationTest/Springboard365.Xrm.Plugins.Core.IntegrationTest.sln
  - xbuild Springboard365.Xrm.Plugins.Core.IntegrationTest.sln /p:Configuration=Release;TargetFrameworkProfile="";TargetFrameworkVersion=4.5
  - mono ./tools/NUnit.ConsoleRunner/tools/nunit3-console.exe ./Springboard365.Xrm.Plugins.Core.IntegrationTest/bin/Release/Springboard365.Xrm.Plugins.Core.IntegrationTest.dll  --work=./TestResult/Integration/Net40
  - echo "Information(Context.Environment.Runtime.CakeVersion.ToString());" > build.cake
  - ./build.sh || exit 1
  - ls -D -R
before_deploy:
  - echo "CrmConnection $dynamics_crm_url $dynamics_crm_username $dynamics_crm_password $dynamics_crm_device_id $dynamics_crm_device_password"
deploy:
  provider: script
  skip_cleanup: true
  script: mono ./tools/Springboard365.Tools.DynamicsCrm.ImportCustomizations/tools/Springboard365.Tools.DynamicsCrm.ImportCustomizations.exe /?
  on:
    branch: master